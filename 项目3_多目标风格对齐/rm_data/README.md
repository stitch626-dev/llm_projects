# 奖励模型数据构造与处理系统（重构版）

## 项目概述

这个项目演示了如何构建一个完整的奖励模型（Reward Model）数据处理流水线，用于训练大语言模型的风格分类器。重构后的系统实现了数据与代码分离，使用配置文件管理参数，支持从JSON文件读取原始数据并输出结构化的训练数据集。

## 核心功能

### 🎯 奖励模型目标
- **输入**: 用户问题 + 模型回答
- **输出**: 风格分类概率 (如: honesty[0.74], helpful[0.21])
- **应用**: 强化学习中的奖励信号，指导模型优化方向

### 📊 五类风格维度
1. **售前** (sales_oriented) - 销售导向风格
2. **售后** (after_sales) - 售后服务风格  
3. **诚实** (honesty) - 诚实客观风格
4. **有帮助** (helpful) - 有帮助风格
5. **无伤害** (harmless) - 无伤害安全风格

## 项目结构

```
rm_code/
├── reward_model_data_processing.py  # 主处理脚本
├── rm_data/                        # 数据目录
│   ├── input_data/                 # 输入数据目录
│   │   ├── config.json            # 配置文件
│   │   ├── business_data.json     # 业务对话数据
│   │   └── opensource_data.json   # 开源风格数据
│   └── output_data/               # 输出数据目录
│       ├── final_dataset.json     # 完整数据集
│       ├── training_data.json     # 训练格式数据
│       ├── style_sales_oriented.json    # 售前风格数据
│       ├── style_after_sales.json       # 售后风格数据
│       ├── style_helpful.json           # 有帮助风格数据
│       ├── style_harmless.json          # 无伤害风格数据
│       └── style_honesty.json           # 诚实风格数据
└── readme.md                      # 项目说明
```

## 数据处理流水线

### 步骤1: 数据加载
- 从 `business_data.json` 加载业务对话数据
- 从 `opensource_data.json` 加载开源风格数据
- 从 `config.json` 加载配置参数

### 步骤2: 场景映射
- 将8+种业务场景标签映射到5类风格维度
- 统一数据格式和标签体系

### 步骤3: 质量筛选
- 保留4星以上高质量对话数据
- 确保训练数据的高质量

### 步骤4: 对话拆分
- 多轮对话拆分为单轮问答对
- 保留上下文信息

### 步骤5: 数据清洗与重写
- 去除特殊字符，规范化格式
- 模拟大模型重写过程

### 步骤6: 去重处理
- 精确去重（hash匹配）
- 语义去重（相似度检测）

### 步骤7: 数据集整合
- 业务数据 + 开源数据混合
- 各风格数据均衡分布

### 步骤8: 分类保存
- 按风格保存独立JSON文件
- 生成统一训练格式

## 使用方法

### 1. 基本运行
```bash
# 运行完整数据处理流水线
python3 reward_model_data_processing.py
```

### 2. 自定义数据
- 编辑 `rm_data/input_data/business_data.json` 添加业务数据
- 编辑 `rm_data/input_data/opensource_data.json` 添加开源数据
- 修改 `rm_data/input_data/config.json` 调整处理参数

### 3. 配置文件说明

**场景映射配置**:
```json
{
  "scene_to_style_mapping": {
    "商品咨询": "售前",
    "价格询问": "售前",
    "技术支持": "有帮助",
    ...
  }
}
```

**处理参数配置**:
```json
{
  "processing_settings": {
    "min_score": 4,              // 最低质量评分
    "duplicate_threshold": 0.7,   // 相似度阈值
    "target_business_ratio": 0.72 // 目标业务数据比例
  }
}
```

## 输出格式

### 1. 训练数据格式 (`training_data.json`)
```json
{
  "input": "用户问题：这款手机有什么特色功能？\n回答：这款手机拥有3000W高清摄像头...",
  "label": "售前",
  "label_english": "sales_oriented",
  "metadata": {
    "source": "business",
    "scene": "商品咨询",
    "turn_id": "conv_001_turn_1"
  }
}
```

### 2. 风格独立数据格式 (`style_*.json`)
```json
{
  "metadata": {
    "style_name": "售前",
    "style_english": "sales_oriented",
    "sample_count": 7,
    "creation_time": "2025-01-01 12:00:00"
  },
  "samples": [
    {
      "user_query": "这款手机有什么特色功能？",
      "agent_reply": "这款手机拥有3000W高清摄像头...",
      "source": "business",
      "turn_id": "conv_001_turn_1",
      "scene": "商品咨询"
    }
  ]
}
```

### 3. RM推理输出格式
```
RM: honesty[0.74] helpful[0.21] sales[0.05]
```

## 奖励分数计算

**公式**: `奖励分数 = 概率值 × 风格权重 + 额外奖励`

**权重设置**:
- 售前: 0.8 (中等优先级)
- 售后: 0.9 (高优先级)  
- 诚实: 1.0 (最高优先级)
- 有帮助: 0.95 (高优先级)
- 无伤害: 1.0 (最高优先级)

**额外奖励**:
- 诚实 & 概率>0.6: +0.05
- 无伤害 & 概率>0.6: +0.05

## 重构亮点

### 🔧 技术改进
- **数据代码分离**: 原始数据保存为JSON文件，便于维护
- **配置化管理**: 通过config.json统一管理参数和映射关系
- **相对路径**: 使用相对路径，便于项目迁移
- **模块化设计**: 各处理步骤独立，便于扩展

### 📁 文件组织
- **输入输出分离**: input_data和output_data目录清晰分工
- **按风格分类**: 每种风格独立保存为JSON文件
- **元数据完整**: 每个文件包含完整的元数据信息

### 🚀 易用性提升
- **一键运行**: 单个命令完成完整流水线
- **灵活配置**: 通过修改JSON文件调整处理逻辑
- **完整追踪**: 保留数据来源和处理历史

## 扩展指南

### 添加新风格类别
1. 在 `config.json` 中添加场景到风格的映射
2. 在 `style_to_english` 中添加中英文对照
3. 重新运行处理脚本

### 添加新数据源
1. 创建新的JSON数据文件
2. 在主脚本中添加加载逻辑
3. 更新配置文件

### 调整处理参数
- 修改 `config.json` 中的 `processing_settings`
- 调整质量筛选、去重阈值等参数

## 应用场景

- **强化学习**: 为RLHF提供奖励信号
- **风格控制**: 控制生成内容的风格倾向
- **质量评估**: 自动评估回答质量和风格符合度
- **A/B测试**: 比较不同模型版本的风格表现
- **数据标注**: 为人工标注提供预处理数据

## 核心学习要点

### 1. 数据工程最佳实践
- **分离关注点**: 数据、配置、代码各司其职
- **版本控制**: JSON格式便于版本管理和diff比较
- **可重现性**: 完整的配置和数据记录确保结果可重现

### 2. 机器学习流水线设计
- **模块化架构**: 每个步骤独立且可复用
- **错误处理**: 完整的异常处理和日志输出
- **性能追踪**: 每步处理结果的详细统计

### 3. 奖励模型实战经验
- **多源数据融合**: 业务数据+开源数据提高泛化能力
- **风格差异化权重**: 根据业务需求设置不同优先级
- **质量控制策略**: 多层次筛选确保数据质量

这个重构版本展示了工业级数据处理系统的设计理念，特别适合学习和理解大规模机器学习项目的数据工程实践。
